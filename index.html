<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEMINI BUNDLER TERMINAL v9.5 (FIXED)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/bs58@4.0.1/bundle/index.js"></script>
    <style>
        /* Cyberpunk Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4338ca; }
        .tab-active { border-bottom: 2px solid #6366f1; color: white; background: rgba(99, 102, 241, 0.1); }
        .tab-inactive { color: #64748b; }
        .tab-inactive:hover { color: #94a3b8; }
        /* Input autofill fix */
        input:-webkit-autofill,
        input:-webkit-autofill:hover, 
        input:-webkit-autofill:focus, 
        input:-webkit-autofill:active{
            -webkit-box-shadow: 0 0 0 30px #020617 inset !important;
            -webkit-text-fill-color: white !important;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-mono text-sm h-screen flex flex-col overflow-hidden">

    <header class="bg-slate-900 border-b border-slate-800 p-3 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-red-500 animate-pulse shadow-[0_0_10px_red]" id="statusLight"></div>
            <h1 class="font-black text-lg tracking-tight text-white">GEMINI <span class="text-indigo-500">BUNDLER v9.5</span></h1>
        </div>
        
        <div class="flex items-center gap-2">
            <input id="rpcInput" type="text" value="https://api.mainnet-beta.solana.com" placeholder="Custom RPC URL..." 
                class="bg-slate-950 border border-slate-700 text-slate-400 text-[10px] p-1 rounded w-64 focus:border-indigo-500 outline-none">
            <button onclick="initConnection()" class="bg-indigo-900/50 hover:bg-indigo-900 text-indigo-300 text-[10px] px-2 py-1 rounded border border-indigo-800 transition-colors">
                SET RPC
            </button>
        </div>

        <div class="flex items-center gap-4 text-xs">
            <div id="rpcStatus" class="text-slate-500 font-bold">RPC: DISCONNECTED</div>
            <div class="bg-slate-800 px-3 py-1 rounded border border-slate-700">
                MAIN: <span id="mainBal" class="text-indigo-400 font-bold">0.00</span> SOL
            </div>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <div class="w-[450px] flex flex-col border-r border-slate-800 bg-slate-900/50 overflow-y-auto p-4 gap-4">
            
            <div class="p-4 rounded-xl border border-indigo-500/20 bg-slate-900 shadow-lg relative overflow-hidden group">
                <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                <h3 class="text-indigo-400 font-bold text-xs uppercase mb-2">1. Main Authority</h3>
                <input id="pkInput" type="password" placeholder="Paste Private Key (Base58 or JSON)..." 
                    class="w-full bg-slate-950 border border-slate-800 text-slate-300 p-2 rounded text-xs focus:border-indigo-500 outline-none mb-2 placeholder:text-slate-600">
                <button onclick="connectWallet()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 rounded text-xs transition-all shadow-lg shadow-indigo-900/20">
                    CONNECT WALLET
                </button>
            </div>

            <div class="flex border-b border-slate-800">
                <button onclick="switchTab('launch')" id="tab-launch" class="flex-1 py-2 text-xs font-bold tab-active">üöÄ LAUNCH</button>
                <button onclick="switchTab('snipe')" id="tab-snipe" class="flex-1 py-2 text-xs font-bold tab-inactive">üéØ SNIPE</button>
                <button onclick="switchTab('wallets')" id="tab-wallets" class="flex-1 py-2 text-xs font-bold tab-inactive">üëõ WALLETS</button>
            </div>

            <div id="view-launch" class="space-y-3">
                
                <div class="bg-slate-800/50 p-3 rounded border border-slate-700">
                    <div class="flex gap-2 mb-2">
                        <input id="cloneCA" type="text" placeholder="Paste CA to Clone..." class="flex-1 bg-slate-950 border border-slate-700 p-2 rounded text-xs">
                        <button onclick="cloneCoin()" class="px-3 bg-slate-700 hover:bg-slate-600 rounded text-xs font-bold">CLONE META</button>
                    </div>
                </div>

                <div class="space-y-2">
                    <div class="flex gap-2">
                        <input id="tName" type="text" placeholder="Token Name" class="w-1/2 bg-slate-950 border border-slate-700 p-2 rounded text-xs focus:border-indigo-500 outline-none">
                        <input id="tSymbol" type="text" placeholder="Ticker ($GEMINI)" class="w-1/2 bg-slate-950 border border-slate-700 p-2 rounded text-xs focus:border-indigo-500 outline-none">
                    </div>
                    <textarea id="tDesc" placeholder="Description..." class="w-full bg-slate-950 border border-slate-700 p-2 rounded text-xs h-16 focus:border-indigo-500 outline-none"></textarea>
                    
                    <div class="grid grid-cols-3 gap-2">
                        <input id="tTwitter" type="text" placeholder="Twitter URL" class="bg-slate-950 border border-slate-700 p-2 rounded text-[10px] focus:border-blue-400 outline-none">
                        <input id="tTelegram" type="text" placeholder="Telegram URL" class="bg-slate-950 border border-slate-700 p-2 rounded text-[10px] focus:border-blue-400 outline-none">
                        <input id="tWebsite" type="text" placeholder="Website URL" class="bg-slate-950 border border-slate-700 p-2 rounded text-[10px] focus:border-blue-400 outline-none">
                    </div>

                    <div class="relative group">
                        <div class="absolute inset-0 bg-indigo-500/10 rounded pointer-events-none group-hover:bg-indigo-500/20 transition-all"></div>
                        <input type="file" id="tImage" accept="image/*" class="w-full text-xs text-slate-500
                          file:mr-4 file:py-2 file:px-4
                          file:rounded file:border-0
                          file:text-xs file:font-semibold
                          file:bg-indigo-900 file:text-indigo-300
                          hover:file:bg-indigo-800 cursor-pointer p-2
                        "/>
                    </div>
                    
                    <div class="flex gap-2 pt-2 border-t border-slate-800 mt-2">
                        <div class="flex-1">
                            <label class="text-[10px] text-slate-500 uppercase font-bold">Dev Buy (SOL)</label>
                            <input id="devBuy" type="number" value="1.0" step="0.1" class="w-full bg-slate-950 border border-slate-700 p-2 rounded text-xs text-emerald-400 font-bold focus:border-emerald-500 outline-none">
                        </div>
                        <div class="flex-1">
                            <label class="text-[10px] text-slate-500 uppercase font-bold">Wallets to Bundle</label>
                            <input id="bundleCount" type="number" value="5" class="w-full bg-slate-950 border border-slate-700 p-2 rounded text-xs text-blue-400 font-bold focus:border-blue-500 outline-none">
                        </div>
                    </div>
                </div>

                <button onclick="executeBundle()" class="w-full bg-gradient-to-r from-green-700 to-emerald-600 hover:from-green-600 hover:to-emerald-500 text-white font-black py-4 rounded shadow-lg shadow-green-900/20 text-sm mt-2 transition-all transform hover:scale-[1.02]">
                    DEPLOY BUNDLE + ADD SOCIALS
                </button>
            </div>

            <div id="view-snipe" class="space-y-3 hidden">
                <div class="bg-slate-800/50 p-4 rounded border border-slate-700 space-y-3">
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-bold">Target Token Address (CA)</label>
                        <input id="snipeCA" type="text" placeholder="Paste CA..." class="w-full bg-slate-950 border border-slate-700 p-2 rounded text-xs text-yellow-400 font-mono focus:border-yellow-500 outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase font-bold">Buy Amount (SOL)</label>
                            <input id="snipeAmt" type="number" value="0.1" step="0.01" class="w-full bg-slate-950 border border-slate-700 p-2 rounded text-xs focus:border-yellow-500 outline-none">
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase font-bold">Slippage %</label>
                            <input id="snipeSlip" type="number" value="20" class="w-full bg-slate-950 border border-slate-700 p-2 rounded text-xs focus:border-yellow-500 outline-none">
                        </div>
                    </div>
                </div>
                <button onclick="startSnipe()" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white font-black py-4 rounded shadow-lg text-sm transition-all">
                    START SNIPER MONITOR
                </button>
            </div>

            <div id="view-wallets" class="space-y-3 hidden">
                <div class="p-3 bg-slate-800/30 rounded border border-slate-700">
                    <h4 class="font-bold text-xs mb-2 text-slate-400">GENERATOR</h4>
                    <div class="flex gap-2">
                        <input id="genCount" type="number" value="10" class="w-20 bg-slate-950 border border-slate-700 p-1 rounded text-center text-xs">
                        <button onclick="generateWallets()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-xs rounded font-bold transition-colors">GENERATE NEW</button>
                    </div>
                </div>
                
                <div class="p-3 bg-slate-800/30 rounded border border-slate-700">
                    <h4 class="font-bold text-xs mb-2 text-slate-400">FUNDER</h4>
                    <div class="flex gap-2 mb-2">
                        <input id="fundAmt" type="number" value="0.1" placeholder="SOL Amount" class="flex-1 bg-slate-950 border border-slate-700 p-2 rounded text-xs">
                        <button onclick="fundAll()" class="bg-blue-600 hover:bg-blue-500 px-4 rounded text-xs font-bold transition-colors">SEND SOL</button>
                    </div>
                    <div class="text-[10px] text-slate-500">Sends specified SOL to ALL generated wallets below.</div>
                </div>
            </div>

        </div>

        <div class="flex-1 flex flex-col bg-black">
            
            <div class="h-1/2 border-b border-slate-800 p-4 overflow-y-auto">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-slate-400 text-xs uppercase">Generated Wallets</h3>
                    <button onclick="exportKeys()" class="text-[10px] text-indigo-400 hover:text-indigo-300 hover:underline">DOWNLOAD CSV</button>
                </div>
                <div id="walletList" class="space-y-1 text-[10px] font-mono text-slate-500">
                    <div class="text-slate-700 italic p-2">No wallets generated yet... generate in 'Wallets' tab.</div>
                </div>
            </div>

            <div class="h-1/2 p-4 bg-slate-950 flex flex-col">
                <h3 class="font-bold text-slate-400 text-xs uppercase mb-2 border-b border-slate-800 pb-1 flex justify-between">
                    <span>System Logs</span>
                    <button onclick="document.getElementById('logs').innerHTML=''" class="text-[10px] text-slate-600 hover:text-slate-400">CLEAR</button>
                </h3>
                <div id="logs" class="flex-1 overflow-y-auto font-mono text-[11px] space-y-1 p-1 scroll-smooth">
                    <div class="text-green-900">> System Ready. v9.5 Loaded.</div>
                    <div class="text-slate-600">> Please set a custom RPC for best performance.</div>
                </div>
                
                <div class="mt-2 pt-2 border-t border-slate-800 flex gap-2">
                    <button onclick="instaSell()" class="flex-1 bg-red-900/40 border border-red-800/50 text-red-400 py-3 rounded text-xs font-bold hover:bg-red-900/80 uppercase transition-all">
                        ‚ö†Ô∏è PANIC SELL ALL
                    </button>
                    <button onclick="returnSol()" class="flex-1 bg-slate-800 border border-slate-700 text-slate-400 py-3 rounded text-xs font-bold hover:bg-slate-700 uppercase transition-all">
                        REFUND SOL TO MAIN
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CORE VARIABLES ---
        let connection;
        let mainWallet;
        let subWallets = [];
        let isSniping = false;

        // --- UTILS ---
        const log = (msg, type='info') => {
            const box = document.getElementById('logs');
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString().split(' ')[0];
            
            if(type === 'error') div.className = "text-red-400 font-bold bg-red-900/10 px-1 rounded";
            else if(type === 'success') div.className = "text-emerald-400 font-bold";
            else if(type === 'warn') div.className = "text-yellow-400";
            else div.className = "text-slate-400";

            div.innerHTML = `<span class="opacity-30 mr-2">[${time}]</span>${msg}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        };

        const sleep = ms => new Promise(r => setTimeout(r, ms));

        // --- TABS ---
        function switchTab(tab) {
            ['launch', 'snipe', 'wallets'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).className = "flex-1 py-2 text-xs font-bold tab-inactive";
            });
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).className = "flex-1 py-2 text-xs font-bold tab-active";
        }

        // --- RPC CONNECTION (FIXED) ---
        async function initConnection() {
            const rpcUrl = document.getElementById('rpcInput').value.trim();
            if(!rpcUrl) return log("Please enter an RPC URL", "error");
            
            log(`Connecting to RPC...`, "warn");
            
            try {
                connection = new solanaWeb3.Connection(rpcUrl, 'confirmed');
                const version = await connection.getVersion(); // Test connection
                
                document.getElementById('statusLight').classList.remove('bg-red-500', 'animate-pulse', 'shadow-[0_0_10px_red]');
                document.getElementById('statusLight').classList.add('bg-emerald-500', 'shadow-[0_0_10px_emerald]');
                document.getElementById('rpcStatus').innerText = "RPC: CONNECTED";
                document.getElementById('rpcStatus').className = "text-emerald-500 font-bold";
                
                log(`RPC Connected! Node Version: ${version['solana-core']}`, "success");
                
                if(mainWallet) refreshBalance();

            } catch(e) {
                document.getElementById('statusLight').classList.add('bg-red-500', 'animate-pulse');
                document.getElementById('statusLight').classList.remove('bg-emerald-500');
                document.getElementById('rpcStatus').innerText = "RPC: DISCONNECTED";
                document.getElementById('rpcStatus').className = "text-red-500 font-bold";
                log(`RPC Connection Failed: ${e.message}`, "error");
            }
        }

        // --- WALLET CONNECTION (FIXED FOR V9.5) ---
        async function connectWallet() {
            // Ensure RPC is ready first
            if(!connection) await initConnection();

            const rawKey = document.getElementById('pkInput').value.trim();
            if(!rawKey) return log("Please enter a private key", "error");

            try {
                let secretKey;
                // 1. Try JSON Parsing (e.g. [123, 45, ...])
                if (rawKey.startsWith('[') && rawKey.endsWith(']')) {
                    try {
                        secretKey = Uint8Array.from(JSON.parse(rawKey));
                    } catch(jsonErr) {
                        throw new Error("Invalid JSON Key format");
                    }
                } 
                // 2. Try Base58 Decoding (Standard format)
                else {
                    try {
                        secretKey = bs58.decode(rawKey);
                    } catch(bs58Err) {
                        throw new Error("Invalid Base58 Key string");
                    }
                }

                if (secretKey.length !== 64) throw new Error("Key must be 64 bytes (Solana Standard)");

                mainWallet = solanaWeb3.Keypair.fromSecretKey(secretKey);
                
                log(`Wallet Attached: ${mainWallet.publicKey.toBase58().slice(0,6)}...${mainWallet.publicKey.toBase58().slice(-4)}`, "success");
                refreshBalance();
                
            } catch(e) {
                log("INVALID KEY: " + e.message, "error");
            }
        }

        async function refreshBalance() {
            if(!mainWallet || !connection) return;
            try {
                const bal = await connection.getBalance(mainWallet.publicKey);
                document.getElementById('mainBal').innerText = (bal / 1e9).toFixed(3);
            } catch(e) {
                log("Fetch Balance Error (RPC Issue)", "error");
            }
        }

        // --- WALLET MANAGER ---
        function generateWallets() {
            const count = parseInt(document.getElementById('genCount').value);
            const list = document.getElementById('walletList');
            list.innerHTML = "";
            subWallets = [];

            for(let i=0; i<count; i++) {
                const kp = solanaWeb3.Keypair.generate();
                subWallets.push(kp);
                
                const div = document.createElement('div');
                div.className = "flex justify-between border-b border-slate-900 pb-1 hover:bg-slate-900 px-2";
                div.innerHTML = `
                    <span class="text-indigo-400 font-bold">W${i+1}</span>
                    <span class="text-slate-500 font-mono">${kp.publicKey.toBase58()}</span>
                `;
                list.appendChild(div);
            }
            log(`Generated ${count} fresh wallets. ready for bundle.`, "info");
        }

        async function fundAll() {
            if(!mainWallet) return log("Connect Main Wallet first!", "error");
            if(subWallets.length === 0) return log("Generate wallets first!", "warn");

            const amount = parseFloat(document.getElementById('fundAmt').value);
            log(`Funding ${subWallets.length} wallets with ${amount} SOL each...`, "warn");

            for (let i = 0; i < subWallets.length; i++) {
                try {
                    const tx = new solanaWeb3.Transaction().add(
                        solanaWeb3.SystemProgram.transfer({
                            fromPubkey: mainWallet.publicKey,
                            toPubkey: subWallets[i].publicKey,
                            lamports: Math.floor(amount * 1e9)
                        })
                    );
                    const sig = await solanaWeb3.sendAndConfirmTransaction(connection, tx, [mainWallet]);
                    log(`Funded W${i+1}: ${sig.slice(0,8)}...`, "success");
                    await sleep(200); // Rate limit protection
                } catch(e) {
                    log(`Failed W${i+1}: ${e.message}`, "error");
                }
            }
            log("Funding Cycle Complete.", "success");
        }

        function exportKeys() {
            if(subWallets.length === 0) return log("No wallets to export", "error");
            let csv = "Wallet_Name,Public_Key,Private_Key_Base58\n";
            subWallets.forEach((w, i) => {
                csv += `Wallet_${i+1},${w.publicKey.toBase58()},${bs58.encode(w.secretKey)}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "gemini_bundle_wallets.csv";
            a.click();
            log("Keys downloaded successfully", "success");
        }

        // --- CLONE LOGIC ---
        async function cloneCoin() {
            const ca = document.getElementById('cloneCA').value;
            if(!ca) return log("Paste a CA first", "warn");
            
            log(`Fetching metadata for ${ca}...`, "info");
            try {
                const res = await fetch(`https://frontend-api.pump.fun/coins/${ca}`);
                if(!res.ok) throw new Error("Coin not found");
                const data = await res.json();

                document.getElementById('tName').value = data.name;
                document.getElementById('tSymbol').value = data.symbol;
                document.getElementById('tDesc').value = data.description;
                if(data.twitter) document.getElementById('tTwitter').value = data.twitter;
                if(data.telegram) document.getElementById('tTelegram').value = data.telegram;
                if(data.website) document.getElementById('tWebsite').value = data.website;
                
                log("Metadata cloned!", "info");
                
                if(data.image_uri) {
                    log("Downloading image...", "info");
                    const imgRes = await fetch(data.image_uri);
                    const blob = await imgRes.blob();
                    const file = new File([blob], "cloned.png", { type: "image/png" });
                    const container = new DataTransfer();
                    container.items.add(file);
                    document.getElementById('tImage').files = container.files;
                    log("Image attached automatically.", "success");
                }
            } catch(e) {
                log("Clone Failed: " + e.message, "error");
            }
        }

        // --- DEPLOY BUNDLE ---
        async function executeBundle() {
            if(!mainWallet) return log("Connect Wallet!", "error");
            const fileInput = document.getElementById('tImage');
            if(fileInput.files.length === 0) return log("Select an image!", "error");

            log("--- INITIATING BUNDLE SEQUENCE ---", "warn");
            
            // 1. Upload to IPFS
            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
            formData.append("name", document.getElementById('tName').value);
            formData.append("symbol", document.getElementById('tSymbol').value);
            formData.append("description", document.getElementById('tDesc').value);
            
            // Append Socials
            formData.append("twitter", document.getElementById('tTwitter').value || "");
            formData.append("telegram", document.getElementById('tTelegram').value || "");
            formData.append("website", document.getElementById('tWebsite').value || "");
            formData.append("showName", "true");

            try {
                log("Uploading Metadata to IPFS...", "info");
                const metaRes = await fetch("https://pumpportal.fun/api/ipfs", { method: "POST", body: formData });
                const metaData = await metaRes.json();
                
                if(!metaData.metadataUri) throw new Error("IPFS Upload Failed");
                log(`IPFS Hash: ${metaData.metadataUri}`, "success");

                // 2. Prepare Launch
                const devBuy = parseFloat(document.getElementById('devBuy').value);
                const bundleCount = parseInt(document.getElementById('bundleCount').value);
                
                log("Constructing Launch Transaction...", "info");
                
                const response = await fetch('https://pumpportal.fun/api/trade-local', {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        "publicKey": mainWallet.publicKey.toBase58(),
                        "action": "create",
                        "tokenMetadata": {
                            name: metaData.metadata.name,
                            symbol: metaData.metadata.symbol,
                            uri: metaData.metadataUri
                        },
                        "mint": solanaWeb3.Keypair.generate().publicKey.toBase58(),
                        "denominatedInSol": "true",
                        "amount": devBuy, 
                        "slippage": 15,
                        "priorityFee": 0.005,
                        "pool": "pump"
                    })
                });

                if(response.ok) {
                    const buf = await response.arrayBuffer();
                    const tx = solanaWeb3.VersionedTransaction.deserialize(new Uint8Array(buf));
                    tx.sign([mainWallet]);
                    
                    log("Broadcasting Launch to Solana...", "warn");
                    const sig = await connection.sendRawTransaction(tx.serialize());
                    log(`LAUNCH SUCCESSFUL! TX: ${sig}`, "success");
                    
                    // Note: In client-side JS without a backend Jito block engine, 
                    // we cannot guarantee next-block bundle inclusion. 
                    // However, we fire the sub-wallets immediately here.
                    
                    if(subWallets.length > 0) {
                        log("‚ö†Ô∏è NOTE: Auto-buying from sub-wallets requires the CA. Since we generated the mint locally, please check the explorer for the new CA and paste it in the SNIPE tab to swarm it.", "info");
                    }
                    
                } else {
                    log("Launch API Error: " + response.statusText, "error");
                }

            } catch(e) {
                log("Launch Failed: " + e.message, "error");
            }
        }

        // --- SNIPE LOGIC ---
        async function startSnipe() {
            const ca = document.getElementById('snipeCA').value;
            const amt = parseFloat(document.getElementById('snipeAmt').value);
            const slip = parseFloat(document.getElementById('snipeSlip').value);
            
            if(!ca) return log("Enter Token CA", "error");
            if(subWallets.length === 0) return log("No wallets to snipe with!", "error");

            isSniping = true;
            log(`SNIPER ACTIVE: Monitoring ${ca}...`, "warn");

            const check = setInterval(async () => {
                if(!isSniping) clearInterval(check);
                try {
                    const info = await connection.getAccountInfo(new solanaWeb3.PublicKey(ca));
                    if(info) {
                        clearInterval(check);
                        log("TOKEN LIQUIDITY DETECTED! SWARMING...", "success");
                        executeSwarm(ca, amt, slip);
                    }
                } catch(e) {}
            }, 1000);
        }

        async function executeSwarm(ca, amount, slippage) {
            const promises = subWallets.map(async (w, i) => {
                try {
                    const response = await fetch('https://pumpportal.fun/api/trade-local', {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            "publicKey": w.publicKey.toBase58(),
                            "action": "buy",
                            "mint": ca,
                            "denominatedInSol": "true",
                            "amount": amount,
                            "slippage": slippage,
                            "priorityFee": 0.005,
                            "pool": "pump"
                        })
                    });
                    const buf = await response.arrayBuffer();
                    const tx = solanaWeb3.VersionedTransaction.deserialize(new Uint8Array(buf));
                    tx.sign([w]);
                    const sig = await connection.sendRawTransaction(tx.serialize());
                    log(`Wallet ${i+1} Buy: ${sig.slice(0,8)}...`, "success");
                } catch(e) {
                    log(`Wallet ${i+1} Fail: ${e.message}`, "error");
                }
            });
            await Promise.all(promises);
            log("SWARM COMPLETE.", "success");
        }

        // --- SELL & REFUND ---
        async function instaSell() {
            if(!confirm("CONFIRM PANIC SELL ALL?")) return;
            isSniping = false;
            const ca = document.getElementById('snipeCA').value || document.getElementById('cloneCA').value;
            if(!ca) return log("No CA specified to sell!", "error");

            log("INITIATING MASS SELL...", "error");
            
            subWallets.forEach(async (w, i) => {
                try {
                    const response = await fetch('https://pumpportal.fun/api/trade-local', {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            "publicKey": w.publicKey.toBase58(),
                            "action": "sell",
                            "mint": ca,
                            "denominatedInSol": "false",
                            "amount": "100%",
                            "slippage": 50,
                            "priorityFee": 0.01,
                            "pool": "pump"
                        })
                    });
                    if(response.ok) {
                        const buf = await response.arrayBuffer();
                        const tx = solanaWeb3.VersionedTransaction.deserialize(new Uint8Array(buf));
                        tx.sign([w]);
                        await connection.sendRawTransaction(tx.serialize());
                        log(`W${i+1} SOLD 100%`, "success");
                    }
                } catch(e) {
                    log(`Sell Fail W${i+1}`, "error");
                }
            });
        }

        async function returnSol() {
            if(!mainWallet) return;
            log("Returning dust to Main Wallet...", "warn");
            for(let w of subWallets) {
                try {
                    const bal = await connection.getBalance(w.publicKey);
                    if(bal > 5000) { 
                        const tx = new solanaWeb3.Transaction().add(
                            solanaWeb3.SystemProgram.transfer({
                                fromPubkey: w.publicKey,
                                toPubkey: mainWallet.publicKey,
                                lamports: bal - 5000
                            })
                        );
                        await solanaWeb3.sendAndConfirmTransaction(connection, tx, [w]);
                        log(`Refunded from W...${w.publicKey.toBase58().slice(-4)}`, "success");
                    }
                } catch(e) { console.log(e); }
            }
        }
        
        // Auto-init RPC on load if user doesn't touch it
        setTimeout(() => {
            if(!connection) initConnection();
        }, 1000);
    </script>
</body>
</html>
